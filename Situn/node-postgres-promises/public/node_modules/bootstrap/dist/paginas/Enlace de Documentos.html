<!DOCTYPE html>
<html ng-app = "app">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Enlace de Documentos</title>
  
  <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
   
  <link rel="stylesheet" href="\node_modules\bootstrap\dist\css\bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
  <script src="\node_modules\bootstrap\dist\js\bootstrap.min.js"></script>
  <link href="\node_modules\bootstrap\dist\css\bootstrap-datetimepicker.min.css" rel="stylesheet">
  <script type="text/javascript"src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script> 
    <script type="text/javascript"src="\node_modules\bootstrap\dist\js\bootstrap-datetimepicker.min.js"></script>
	
    <!-- Angular--> 
	<script src="\node_modules\bootstrap\dist\js\angular.min.js"></script>
	
    </head>
    <body ng-app ng-controller = "ControllerAngular" data-ng-init = "init()">
	  
	   
	<nav class="navbar navbar-default" style="background-color:#60161E;">
	<div class="container-fluid">
    <!-- REsponsive -->
    <div class="navbar-header" >
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
   <IMG SRC="../../../../img/situn2.png" WIDTH=100 HEIGHT=100  class="nav navbar-nav navbar-right">
    </div>

    <!-- Menu -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav" style="margin-top:7px;">
        <li ><a href="../../../../index.html"style="color:#FFFFFF;">Ingreso Correspondencia</span> </a></li>
        <li><a href="#"style="color:#FFFFFF;">Enlace Documentos</a></li>
        <li><a href="\node_modules\bootstrap\dist\paginas\Busqueda.html"style="color:#FFFFFF;">Búsqueda</a></li>
		<li><a href="#"style="color:#FFFFFF;">Reportes</a></li>
		<li><a href="#"style="color:#FFFFFF;">Escanear</a></li>
		<li><a href="#" style="color:#FFFFFF;">Ayuda</a></li>
      </ul>
    
       		<IMG SRC="../../../../img/situn2.png" WIDTH=100 HEIGHT=100  class="nav navbar-nav navbar-right">
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
	  
	   
	   <!---Cuerpo--->
	   <body background="../../../../img/situn4.png">
	   
	   <table class ="table" style="border: hidden">
			<tr>
				<td width = 45%>
					<div class="col-md-1"></div>
					<div class="col-md-8">
						<span  class="text-danger"><h2>Enlace de Documentos</h2></span>
							
						<form class="form-horizontal">
										
							<div class="form-group">
								<div class = "col-sm-8"> <label class=" control-label  text-danger">Criterio de Búsqueda</label>
								</div>
								<div class="col-xs-8">
									<select class="form-control input-sm" id="opBusqueda" ng-model = "criterio">
										<option value="Nº oficio">Nº Oficio
										<option value="Destinatorio">Destinatorio                                            
										<option value="Remitente">Remitente                                          
										<option value="Asunto">Asunto                                      
									</select>
								</div>
							</div>
							
							<div class="form-group">
								<div class = "col-sm-8"> <label class="col-sm-2 control-label  text-danger">Documento 1</label>
								</div>
								<div class="col-xs-8">
									<input type="text" class = "form-control input-sm" id = "Documento1"  ng-model="doc1.tc_3" ng-Keypress = "buscar('Documento1', $event)" ng-click="setCurrent(1)"></input>
									<input type ="button" class = "btn" id = "editDoc1" value = "editar" ng-click="editar('Documento1')"></input>
								</div>
							</div>
 
							<div class="form-group">
								<label class="col-sm-2 control-label  text-danger">Documento 2</label>
								<div class="col-sm-8">
									<input type="text" class="form-control" id="Documento2"  ng-model = "doc2.tc_3" ng-Keypress = "buscar('Documento2', $event)" ng-click="setCurrent(2)">
									<input type ="button" class = "btn" id = "editDoc2" value = "editar" ng-click="editar('Documento2')"></input>
								</div>
							</div>
						</form>
          
						<div class="col-sm-2">
							<input type = "button"class="btn btn-default" id ="guardar" value = "Realizar Enlace" ng-click = "enlazar()">
						</div>
						<div class="col-sm-3">
      
						</div>
						<div class="col-sm-2">
							<input type = "button" class="btn btn-default" id="cancelar" value = "Cancelar" onclick = "ME_07()" >
						</div>	
						<div style="margin-top:100px; margin-left:60px; "><label id="mensaje" class="text-danger"></label></div>
					</div>	
						
				</td>
						
				<td></td>
				<td>
					<table class = "table table-bordered" id = "busqueda_enlace">
					
							<tr class="danger">
								<td></td>
								<td>Oficio</td>
								<td>Asunto</td>
								<td>Destinatario</td>
								<td>Remitente</td>
								</tr>
							
							<tbody>
								<tr ng-repeat = "c in correspondencias">
									<td> <button ng-click="updateDoc(c)"> + </button> </td>
									<td> {{c.tc_3 }} </td>
									<td> {{c.tc_8 }} </td>
									<td> {{c.tc_5 }} </td>
									<td> {{c.tc_7 }} </td>
								</tr>
							</tbody>
					</table>
				</td>
			</tr>
        </table>
	

		
		
		
<script type="text/javascript">
 document.addEventListener("DOMContentLoaded", ME_01);
  let obj;
  let banderita;
function ME_01(){  //metodo para recuperar el id de la correspondencia guardado en el local storage

	$("#editDoc1").hide();
	$("#editDoc2").hide();

	 obj  = JSON.parse(localStorage.getItem("user"));
	 console.log("Objeto cargado de local.." + localStorage.getItem("user"));
	  banderita = obj.bandera;
	  if ( banderita==true){
	  document.getElementById("Documento1").value=obj.numOficio;
	  document.getElementById("Documento1").disabled=true;
	 // localStorage.clear();
	  }
	  localStorage.clear();
}





	var app = angular.module('app', []);


function ME_02($scope)//ControllerAngular
 {
	$scope.correspondencias = new Array();
	$scope.doc1 = {'tc_3': ""};
	$scope.doc2;
	$scope.current;
	$scope.criterio = "Asunto";	
	$scope.init = _ => console.log("Se ha iniciado el sistema...");
	$scope.setCurrent = c => $scope.current = c;
	$scope.updateDoc = a => ME_03(a, $scope);//$scope.current == 1? ($scope.doc1 = a, deshabilitar('Documento1')): ($scope.doc2 = a, deshabilitar('Documento2'));
	
	$scope.updateCorrespondencias = c => $scope.correspondencias = c;
	$scope.buscar = (a,b) => ME_05(a,$scope,b);
	$scope.enlazar = _ => ME_06($scope);
	
	$scope.editar = d => ME_04(d, $scope);//(d == "Documento1") ? ($scope.doc1 = null, habilitar(d)) : ($scope.doc2 = null, habilitar(d));
		
  }
  
   app.controller('ControllerAngular', ME_02);
   
   
	function ME_03(a, $scope)//Modifica ellos campos documento1 o documento2
	{
		$scope.current == 1? ($scope.doc1 =  a, $("#editDoc1").show() ): ($scope.doc2 = a , $("#editDoc2").show());
		let id = ($scope.current == 1)? "Documento1" : "Documento2";
		$("#" + id ).attr("value",a.tc_3);
		$("#" + id ).prop('disabled', true);
	}
	
	function ME_04(d, $scope)//Edita el documento
	{
		(d == "Documento1") ? ($scope.doc1 = null, $("#editDoc1").hide()) : ($scope.doc2 = null, $("#editDoc2").hide());
		$("#"+d).prop('disabled', false);
		  document.getElementById("mensaje").innerHTML="";
	}
  
/*
 *	Realiza la busqueda en la base de datos de los elementos que coinciden
 *	parcialmente con el criterio, ya sea para el documento 1 o el 2 
 */
	function ME_05(id, $scope,h) //Metodo de buscar
	{
		let keycode = (h.which)?h.which : h.keyCode;
		let h3 = document.getElementById(id).value;
		let criterio = ((keycode != 8)?(h3 + String.fromCharCode(keycode)) : h3.substr(0,h3.length-1)).toUpperCase();

	
		fetch( 'http://localhost:3000/api/TC/' + ME_08($scope), {  
			method: 'POST', 
			datatype:'json',
			headers: {  
				"Content-type": "application/x-www-form-urlencoded"  
			} ,
			body: ME_09($scope) + "="+ criterio
		})	 
		.then(res => res.json())
		.then(obj =>  
				$scope.$apply( _=>
					$scope.updateCorrespondencias(obj.data)) 
		)  
		.catch(err => console.log('Request failed', err));
	}
	
	
	function ME_08($scope)// Toma el tipo de busqueda y regresa el sufijo correspondiente a la dirección del servidor
{
	let op = $scope.criterio;
	console.log("El tipo de busqueda es por: |" + op + "|");
	switch(op)
	{
		case 'Nº oficio': // Oficio
			return 'BO';
		case 'Destinatorio': // Destinatario
			return 'BD';
		case 'Remitente': // Remitente
			return 'BR';
		case 'Asunto': // Asunto
			return 'BA';
	}
}  
function ME_09($scope) //Toma el criterio de busqueda y devuelve la columna que se debe buscar en la BD
{
	let op = $scope.criterio;
	switch(op)
	{
		case 'Nº oficio': // Oficio
			return 'TC_3';
		case 'Destinatorio': // Destinatario
			return 'TC_5';
		case 'Remitente': // Remitente
			return 'TC_7';
		case 'Asunto': // Asunto
			return 'TC_8';
	}
	
} 
	
	
 
 /*
  *		Realiza el enlace de los documentos seleccionados
  */
  
	function ME_06($scope){//Crea el enlace entre documentos
	  let a4;
	  let b4;
	  if(banderita == true){
		a4 = obj.id;
		b4 = $scope.doc2.tc_1;
		localStorage.clear();
		}
		else{
		a4= $scope.doc1.tc_1;
		b4 = $scope.doc2.tc_1;}
		
		console.log(a4 , b4);
		if(a4==b4){
		document.getElementById("mensaje").innerHTML="Fallo al realizar la acción, el documento a enlazar es el mismo";
		}
		else{
		fetch( 'http://localhost:3000/api/TE/I', {  
			method: 'POST', 
			datatype:'json',
			headers: {  
				"Content-type": "application/x-www-form-urlencoded"  
			} ,
			body: "TE_1="+ a4 + "&TE_2="+ b4
		}
		)
		.then(function(response) {
			return response.text().then(function(res) {
					if(res.indexOf("error")==-1){
					console.log(res);
  document.getElementById("mensaje").innerHTML="Acción realizada con exito";
  setTimeout(ME_07, 3000);
  }
  else
  document.getElementById("mensaje").innerHTML="Fallo al realizar la acción";
    
			});
		})
		.catch(function(error) {  
			console.log('Request failed', error);  
		});
		}
  }
  
  function ME_07(){//Limpia los campos , Metodo Cancelar
  document.getElementById("Documento1").value="";
   document.getElementById("Documento2").value="";
  document.getElementById("Documento1").disabled=false;
  document.getElementById("Documento2").disabled=false;
  document.getElementById("mensaje").innerHTML="";
  }
  
  /*Super comentario para poder subir los cambios al cochino github*/
    
</script>


    </body>
</html>
