<!DOCTYPE html>
<html ng-app = "app">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Ingreso Correspondencia</title>
     
	 
 <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
   
  <link rel="stylesheet" href="\node_modules\bootstrap\dist\css\bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
  <script src="\node_modules\bootstrap\dist\js\bootstrap.min.js"></script>
  <link href="\node_modules\bootstrap\dist\css\bootstrap-datetimepicker.min.css" rel="stylesheet">

  <script type="text/javascript"src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script> 
    <!--script type="text/javascript"src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script-->
    <script type="text/javascript"src="\node_modules\bootstrap\dist\js\bootstrap-datetimepicker.min.js"></script>

     <!--Eliminar este archivo de css---link href="\node_modules\bootstrap\dist\css\style.css" rel="stylesheet"--->
 
 <link rel="stylesheet" href="datepicker.css">
        <link rel="stylesheet" href="bootstrap.css">   
		
			
	<!-- Angular--> 
	<script src="\node_modules\bootstrap\dist\js\angular.min.js"></script>
	
   </head>
   
    <body  id = "buscar" data-ng-init = "init()">      	  	   
	<nav class="navbar navbar-default" style="background-color:#60161E; ">
    <div class="container-fluid">
    <!-- REsponsive -->
    <div class="navbar-header" >
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
    <IMG SRC="img/situn2.png" WIDTH=90 HEIGHT=90  class="nav navbar-nav navbar-right" >
    </div>
	
    <!-- Menu -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav"  style="margin-top:7px;">
        <li ><a href=""style="color:#FFFFFF;">Ingreso Correspondencia</span> </a></li>
        <li><a href="\node_modules\bootstrap\dist\paginas\Enlace de Documentos.html"style="color:#FFFFFF;">Enlace Documentos</a></li>
        <li><a href="\node_modules\bootstrap\dist\paginas\Busqueda.html"style="color:#FFFFFF;">Búsqueda</a></li>
		<li><a href="#"style="color:#FFFFFF;">Reportes</a></li>
		<li><a href="#"style="color:#FFFFFF;">Escanear</a></li>
		<li><a href="#" style="color:#FFFFFF;">Pendientes</a></li>
		<li><a href="#" style="color:#FFFFFF;">Ayuda</a></li>
      </ul>
    
        <IMG SRC="img/situn2.png" WIDTH=90 HEIGHT=90  class="nav navbar-nav navbar-right">
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
	  
	   <!---Cuerpo--->
	   <body background="img/situn4.png" ng-app ng-controller = "ControllerAngular">
	      <div class="col-md-1"></div>
	   <div class="col-md-4">
         <span class="text-danger"><h4>Ingreso de Correspondencia</h4></span>
            <form name = "Formulario">
            <table id ="tablaIC">
                <tbody>
						<tr>
                    <td><label class="text-danger">Fecha recibido</label></td>
                    <td> 
					<div id="datetimepicker4" class=" form-group" >	<!-- Calendario--->
					<input id="IC1" data-format="dd-MM-yyyy" class="form-control"type="text" onfocus= "clear_focus(1)" disabled></input> 
					</div>
					</td>
                </tr>
                <tr>
                    <td> <label class="text-danger">N° Oficio</label> </td>
                    <td><div  id="div2"class="form-group"><textarea id="IC2" type="text" class="form-control" onfocus="clear_focus(2)"></textarea>
					<label class="text-danger" style=""><input  type="checkbox" id="IC12" value="first_checkbox" onchange="me()">Sin Oficio</label></div></td>           
					</tr>
                <tr>
                    <td> <label class="text-danger">Fecha Oficio</label></td>
                    <td> <div id="datetimepicker3" class="input-append form-group"><input class="form-control"id="IC3" data-format="dd-MM-yyyy" type="text" onfocus="clear_focus(3)" > <!--****** NUEVO ***********-->
					<span class="add-on"><i  data-date-icon="icon-calendar" onclick="clear_focus(3)"></i></span> 
					</div>
					</td>
                </tr>
                <tr>
                    <td> <label class="text-danger">Destinatario </label></td>
                    <td><div id="div4" class="form-group"><textarea id="IC4" type="text" class="form-control"  onfocus="clear_focus(4)"></textarea></div></td> 
                </tr>
				 <tr>
                    <td> <label class="text-danger">Copia </label></td>
                    <td><div id="div5" class="form-group"><textarea id="IC5" type="text" class="form-control" onfocus="clear_focus(5)"></textarea></div></td> 
                </tr>
				 <tr>
                    <td> <label class="text-danger">Remitente </label></td>
                    <td><div id="div6" class="form-group"><textarea id="IC6" type="text" class="form-control" onfocus="clear_focus(6)"></textarea></div></td>                </tr>
                <tr>
                    <td> <label class="text-danger">Asunto</label></td>
                    <td><div id="div7"class="form-group"><textarea id="IC7" type="text" class="form-control"rows=4 cols=30 onfocus="clear_focus(7)"></textarea></input></div></td> <!--****** NUEVO ***********-->
                </tr>
				<tr>
                    <td> <label class="text-danger">Recibido</label></td>
                    <td><div id="div8"class="form-group"><input id="IC8" type="text"class="form-control" onfocus="clear_focus(8)" value="GRETTEL CASTRO CRUZ" disabled></input> <div></td> <!--****** NUEVO ***********-->
                </tr>
				<tr>
                    <td> <label class="text-danger">Estado</label></td>
                    <td><div id="div9"class="form-group"><textarea type="text" class="form-control" id="IC9"  onfocus="clear_focus(9)"></textarea></div></td> <!--****** NUEVO ***********-->
                </tr>
                <tr>
                    <td> <label class="text-danger">Observaciones</label></td>
                    <td><div id="div10"class="form-group"><textarea type="text"class="form-control" id="IC10"  ></textarea></input></div></td> <!--****** NUEVO ***********-->
                </tr>
                <tr>
                    <td ><center><button type="button" class="btn btn-default" onclick="MIC_07()">Guardar</button></td>
                    <td ><center><button type="button" class="btn btn-default" onclick="MIC_09()">Cancelar</button></td>
                </tr>
						</tbody>
		           </table>  
        </form>  
   
	   </div>
	   
	   
		<div class="col-md-2 form-group"><!--Genera el espacio entre componentes---->	 
			<span class="text-danger"><h4>Alarma</h4></span>
			<Select id="op" onchange = "pro_Alarma()" >
				<Option Selected value="3d" >3 días
				<Option value="5d">5 días
				<Option value="7d" >7 dias
				<Option value="Pd" >Programar
				<Option value="Nd" Selected>Ninguna
			</select>	
			<div  style="display:none" id="div_dias"><span class="text-danger"><h4>Cantidad de días:</h4></span>
				<input type="text"  class="form-control" id = "input_dias"></input>
	  		</div>
				<button id="IC11" style="margin-top:15px"type="button" onclick="MIC_06()"class="btn btn-default"disabled>Enlace</button><!--</a>-->
	 	
		<div style="margin-top:60px"><label id="mensaje" class="text-danger"></label></div>
		
		</div>
	
		<div class="col-md-1 "></div><!--Genera el espacio entre componentes---->	
		
			
			<div class="col-md-3 "> 			
			
			<div class="panel panel-danger"  style=" border-radius: 5px 5px 5px 5px;"><!---div alarmas--->
			<center><span class="text-danger"><h4>Alarmas del día</h4></span>
			<div> No hay disponibles</div></center>	
			
			         <p align="left"><p align="left"><div class="table table-bordered" >
	<p align="left"><table class="table" id="tabla_busqueda">
		      <thead> 
			    <tr class="danger">
			      <td>Nº Oficio</td>
			      <td>Fecha de aviso</td>
			      <td>Fecha de limite</td>
			
			    </tr>
		     </thead>
	  
			<tbody>
			<tr ng-repeat = "c in alarmas">
					<td> {{c.tc_3}} </td>
					<td> {{c.ta_3 | date:'dd/MM/yyyy'}} </td>
					<td> {{c.ta_2 | date:'dd/MM/yyyy'}} </td>
			
			</tr>
		</tbody>    
	        </table>
			
			
			</div> 
			<!---div class="date hero-unit"  style="background-color:#60161E; margin-top:200px; color:white;" ><!-- div calendario----->
          
            <center><div class="date panel panel-danger "  style="background-color:#60161E;  color:white;" ></center><!-- div calendario----->
			   
				 <script src="bootstrap-datepicker.js"></script> <!---Si se borra el pierde trate de acomodarlo 
		        en donde estan los otros js pero dice que no se encuentran, como que este y el bootstrap-datepicker.min.js chocan--->	
			
			
				
        </div>
        </div>
  
   
      
    
 <script src="Correspondencia.js"></script>
	   
	  
  
	   
<script type="text/javascript">

 document.addEventListener("DOMContentLoaded", MIC_08);
 
let app = angular.module('app', []);
function ControllerAngular($scope)
 {
 
	$scope.alarmas = new Array();
	$scope.updateAlarmas= c => $scope.alarmas = c;
	$scope.init = _ => busqueda($scope);
	
		
  }
  
   app.controller('ControllerAngular', ControllerAngular); 

  function busqueda($scope)
 {

	 fetch( 'http://localhost:3000/api/TA/ALL_FECHA', {  
    method: 'POST', 
    datatype:'json',
    headers: {  
      "Content-type": "application/x-www-form-urlencoded"  
      } 
      }
	)	
	.then(res => res.json())
	.then(obj => $scope.$apply( _=>	$scope.updateAlarmas(obj.data)))
	.catch(err => console.log('Request failed', err));
 }

 

 
 
 function clear_focus(n){
  limpiarMensaje();
  MIC_04(n);
 }
 
function MIC_08(){  
	var f = new Date();
	$("#IC1").val(f.getDate() + "-" + (f.getMonth() +1) + "-" + f.getFullYear());
}
function me(){
if(document.getElementById("IC12").checked==true){
	document.getElementById("IC2").value="SIN OFICIO";
	document.getElementById("IC2").disabled=true;
	}
	else{
	document.getElementById("IC2").value="";
	document.getElementById("IC2").disabled=false;
	}
}
 $(document).ready(function () {
                
                $('.date').datepicker({
                     
                });
            
     });
   $(function() {
    $('#datetimepicker3').datetimepicker({
      pickTime: false
    });
  });
  
  
 function MIC_01(){
	//let a3 = document.getElementById('a3').value;
	let b3 = $('#IC1').val().toUpperCase();
	let c3 = $('#IC2').val().toUpperCase(); 
	let d3 = $('#IC3').val().toUpperCase();
	let e3 = $('#IC4').val().toUpperCase();
	let f3 = $('#IC5').val().toUpperCase();
	let g3 = $('#IC6').val().toUpperCase();
	let h3 = $('#IC7').val().toUpperCase();
	let i3 = '1'; // cambiar solo lo puse por que si no mamaron al ingresar
	let j3 = $('#IC9').val().toUpperCase();
    let k3 = $('#IC10').val().toUpperCase();
	
 fetch( 'http://localhost:3000/api/TC/I', {  
    method: 'POST', 
    datatype:'json',
    headers: {  
      "Content-type": "application/x-www-form-urlencoded"  
      } ,
    body: "TC_2="+ b3+ "&TC_3="+c3+
	"&TC_4="+ d3 + "&TC_5="+ e3 +"&TC_6="+ f3 + 
	"&TC_7="+ g3 + "&TC_8="+ h3 +"&TC_9="+ i3+"&TC_10="+ j3+ "&TC_11="+ k3
      }
	  )
  .then(function(response) {
  return response.text().then(function(res) {
    console.log("Resultado: "+res);
	
	if(res.indexOf("error")==-1){
 $("#mensaje").text("Acción realizada con exito");
  if($("#op").val() != "Nd")
  insertTA(); // Analizar
  MIC_03();
  document.getElementById("IC11").disabled=false;
  
  }
  else
  document.getElementById("mensaje").innerHTML="Fallo al realizar la acción";
    
  });
})
  .catch(function(error) {  
  // document.getElementById("mensaje").innerHTML="Fallo al realizar la acción";
   console.log('Request failed', error);  
  });
  
}
	
<!--valida todos los campos--->
function MIC_02(){	
	IC1 = true;
	IC2 = true;
	IC3 = true;
	IC4	= true;
	IC5 = true;
	IC6 = true
	IC7 = true
	IC8 = true
	IC9 = true
	IC10 = true
	
	if($("#IC1").val().length == 0){
		document.getElementById("datetimepicker4").className ="input-append  form-group has-error" ;
		document.getElementById("IC1").title = "Campo Obligatoria" ;
		IC1 = false;
	}
	else{
	document.getElementById("datetimepicker4").className ="input-append  form-group" ;
	document.getElementById("IC1").title = "" ;
	}
	if($("#IC2").val().length == 0){
		document.getElementById("div2").className = "form-group has-error" ;
		document.getElementById("IC2").title = "Campo Obligatorio";
		IC2 = false;
	}
	else{
	document.getElementById("div2").className ="  form-group" ;
	document.getElementById("IC2").title = "" ;
	}
	
	if($("#IC3").val().length == 0){
		document.getElementById("datetimepicker3").className = " input-append  form-group has-error" ;
		document.getElementById("IC3").title = "Campo Obligatorio";
		IC3 = false;
	}
	else{
	document.getElementById("datetimepicker3").className ="input-append  form-group" ;
	document.getElementById("IC3").title = "" ;
	}
	if($("#IC4").val().length == 0){
		document.getElementById("div4").className ="form-group has-error" ;
		document.getElementById("IC4").title = "Campo Obligatorio";
		IC4 = false;
	}
	else{
	document.getElementById("div4").className =" form-group" ;
	document.getElementById("IC4").title = "" ;
	}
	if($("#IC5").val().length == 0){
		document.getElementById("div5").className = "form-group has-error" ;
		document.getElementById("IC5").title = "Campo Obligatorio";
		IC5 = false;
	}
	else{
	document.getElementById("div5").className ="  form-group" ;
	document.getElementById("IC5").title = "" ;
	}
	if($("#IC6").val().length == 0){
		document.getElementById("div6").className = "form-group has-error" ;
		document.getElementById("IC6").title = "Campo Obligatorio";
		IC6 = false;
	}
	else{
	document.getElementById("div6").className ="  form-group" ;
	document.getElementById("IC6").title = "" ;
	}
	if($("#IC7").val().length == 0){
		document.getElementById("div7").className = "form-group has-error" ;
		document.getElementById("IC7").title = "Campo Obligatorio";
		IC7 = false;
	}
	else{
	document.getElementById("div7").className ="form-group" ;
	document.getElementById("IC7").title = "" ;
	}
	if($("#IC8").val().length == 0){
		document.getElementById("div8").className = "form-group has-error" ;
		document.getElementById("IC8").title = "Campo Obligatorio";
		IC8 = false;
	}
	else{
	document.getElementById("div8").className ="  form-group" ;
	document.getElementById("IC8").title = "" ;
	}
	if($("#IC9").val().length == 0){
		document.getElementById("div9").className ="form-group has-error" ;
		document.getElementById("IC9").title = "Campo Obligatorio";
		IC9 = false;
	}
	else{
	document.getElementById("div9").className ="  form-group" ;
	document.getElementById("IC9").title = "" ;
	}
	return (IC1 && IC2  && IC3  && IC4 	&& IC5 && IC6 && IC7 && IC8 && IC9 && MIC_05());
}
<!--limpia todos los campos--->
function MIC_09(){
MIC_03();
limpiarMensaje();
}
function MIC_03(){
for(let i=0;i<10;i++){
MIC_04(i);
}
	$("#IC2").val("");
	$("#IC3").val("");
	$("#IC4").val("");
	$("#IC5").val("");
	$("#IC6").val("");
	$("#IC7").val("");
	//document.getElementById("IC8").value = "";
	$("#IC9").val("");
	$("#IC10").val("");
	//document.getElementById("mensaje").innerHTML="";
	document.getElementById("IC11").disabled=true;
	document.getElementById("IC12").checked=false;
	document.getElementById("IC2").disabled=false;
	}
function limpiarMensaje(){
$("#mensaje").text("");
}
function MIC_04(op){
	switch(op){
	case 1: document.getElementById("datetimepicker4").className= "input-append form-group";break;
	case 2: document.getElementById("div2").className ="form-group" ; break;
	case 3: document.getElementById("datetimepicker3").className ="input-append  form-group" ; break;
	case 4: document.getElementById("div4").className ="  form-group" ;break;
	case 5: document.getElementById("div5").className ="  form-group" ;break;
	case 6: document.getElementById("div6").className ="  form-group" ;break;
	case 7: document.getElementById("div7").className ="  form-group" ;break;
	case 8: document.getElementById("div8").className ="  form-group" ;break;
	case 9: document.getElementById("div9").className ="  form-group" ;break;
	//case 10: document.getElementById("div10").className ="  form-group" ;break
	
	default: break;
	}
}	
function MIC_05(){
let t=$("#IC1").val();
let r=$("#IC3").val();
	if(t>=r){
	document.getElementById("datetimepicker4").className ="input-append  form-group " ;
	document.getElementById("IC1").title = "" ;
	document.getElementById("datetimepicker3").className ="input-append  form-group " ;
	document.getElementById("IC3").title = "" ;
	return true;}
	else{
	document.getElementById("datetimepicker4").className ="input-append  form-group has-error" ;
	document.getElementById("IC1").title = "Fecha de oficio mayor a la de recibido" ;
	document.getElementById("datetimepicker3").className ="input-append  form-group has-error" ;
		document.getElementById("IC3").title = "Fecha de oficio mayor a la de recibido" ;
	return false;}
}
 function MIC_06(){
fetch( 'http://localhost:3000/api/TC/BC', {  
    method: 'GET', 
    datatype:'json',
    headers: {  
      "Content-type": "application/x-www-form-urlencoded"  
      } 
      }
	  )
   .then(res =>res.json())
   .then(obj =>{
   localStorage.clear();
   let y=obj.data[0].tc_1; // TC_1
    let correspondencia = new Correspondencia(obj.data[0].tc_3,y,true); // // Aqui necesitamos los datos de la correspondencia de la BD
   localStorage.setItem("user",JSON.stringify(correspondencia));
   })
   .then( _ => window.location.href='http://localhost:3000/node_modules/bootstrap/dist/paginas/Enlace%20de%20Documentos.html')
   
//<a href="\node_modules\bootstrap\dist\paginas\Enlace de Documentos.html">
  .catch(function(error) {  
  // document.getElementById("mensaje").innerHTML="Fallo al realizar la acción";
   console.log('Request failed', error);  
  });
   	
 	}
function MIC_07(){
	  if(MIC_02() == false){
	     $("#mensaje").text("Campos requeridos");
	     return;
		}
		let parametro = $('#IC2').val().toUpperCase(); 
	fetch( 'http://localhost:3000/api/TC/BO', {  
    method: 'POST', 
    datatype:'json',
    headers: {  
      "Content-type": "application/x-www-form-urlencoded"  
      } ,
    body: "TC_3="+ parametro
      }
	)	 
	.then(res => res.json())
     .then(obj => {
	if(obj.data[0]==null)
	   MIC_01();
	   else{ 
	if(obj.data[0].tc_3=="SIN OFICIO")
		MIC_01();
	else
	  $("#mensaje").text("Fallo al realizar la acción, la correspondencia a ingresar ya existe"); 
	  }
   })
		.catch(err => {
		console.log('Request failed', err)});
		
	}
	
	//--- NUEVO --//
	function pro_Alarma(){
		if($("#op").val() == "Pd"){ // En caso de programar la alarma
			$("#div_dias").show();  
		}
	
		else{
			$("#div_dias").hide();
		}
	
	}
	
	function insertTA(){
	/*fetch( 'http://localhost:3000/api/TC/BC', {  
    method: 'GET', 
    datatype:'json',
    headers: {  
      "Content-type": "application/x-www-form-urlencoded"  
      } 
      }
	  )
   .then(res =>res.json())*/
  // .then(obj =>{ obj.data[0].tc_1; /* TC_1*/})
  
  /*.catch(function(error) {  
   console.log('Request failed', error);  
  });
   	*/
	//console.log("Ultimo "+devuelveUltimo().then(function(obj){obj}));
	var aux = devuelveUltimo();
	aux.then(data=> {

		let a5 = data;  // Cambiar eso falta
		let b5 = getDateLimit();
		let c5 = getDateNotice(); 
		let d5 = 0;
	
		fetch( 'http://localhost:3000/api/TA/I', {  
			method: 'POST', 
			datatype:'json',
			headers: {  
				"Content-type": "application/x-www-form-urlencoded"  
			} ,
			body: "TA_1="+ a5+ "&TA_2="+ b5+ "&TA_3="+c5+"&TA_4="+ d5 
		}
	  )
		.then(function(response) {
			return response.text().then(function(res) {
					console.log("Resultado: "+res);
    
			});
		})
		.catch(function(error) {  
			console.log('Request failed', error);  
		});
	});
  
	}
	
	function getDate(can){
	   var f = new Date(),
           addTime = can * 86400; //Tiempo en segundos
           f.setSeconds(addTime); //Añado el tiempo
	return f.getDate() + "-" + (f.getMonth() +1) + "-" + f.getFullYear();
	}
	
	function getDateLimit(){
	  let opcion = $("#op").val();
	  switch(opcion){
	  case "3d": return getDate(3);
	  case "5d": return getDate(5);
	  case "7d": return getDate(7);
	  case "Pd": return getDate(can_dias = $("#input_dias").val());
	  }
	}
	
	
	
	function getDateNotice(){
	   let opcion = $("#op").val();
	  switch(opcion){
	  case "3d": return getDate(2);
	  case "5d": return getDate(3);
	  case "7d": return getDate(4);
	  case "Pd": return getDate(parseInt($("#input_dias").val())-3);
	  }
	}
	
	function devuelveUltimo(){ 
	return Promise.resolve(fetch( 'http://localhost:3000/api/TC/BC', {  
    method: 'GET', 
    datatype:'json',
    headers: {  
      "Content-type": "application/x-www-form-urlencoded"  
      } 
      }
	  )
   .then(res =>res.json())
   .then(obj =>obj.data[0].tc_1)
  
  .catch(function(error) {  
   console.log('Request failed', error);  
  })
   	);
	}
	
</script>
    </body>
</html>
